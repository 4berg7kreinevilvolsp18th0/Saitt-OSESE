-- ===============================
-- Документация по ролям пользователей
-- ===============================
-- 
-- Этот файл описывает систему ролей и прав доступа в проекте ОСС ДВФУ
-- 
-- ВАЖНО: Роли должны быть созданы в таблице user_roles после настройки Supabase Auth
--

-- ===============================
-- ОПИСАНИЕ РОЛЕЙ
-- ===============================

-- 1. ROLE: 'student' (внешний пользователь)
--    - НЕ требует записи в user_roles (это дефолтное состояние)
--    - Может создавать обращения (публичный доступ)
--    - Может читать обращения только по public_token
--    - Может просматривать публичный контент
--    - НЕ имеет доступа к админ-панели

-- 2. ROLE: 'member' (член ОСС)
--    - Требует записи в user_roles с указанием direction_id
--    - Может видеть обращения своего направления
--    - Может обновлять статусы обращений своего направления
--    - Может добавлять комментарии к обращениям своего направления
--    - Может просматривать внутренние дашборды (ограниченные RLS)
--    - НЕ может управлять контентом
--    - НЕ может управлять ролями других пользователей

-- 3. ROLE: 'lead' (руководитель направления)
--    - Требует записи в user_roles с указанием direction_id
--    - Все права 'member' +
--    - Может управлять контентом (создавать, редактировать, публиковать)
--    - Может видеть расширенную статистику по своему направлению
--    - Может назначать ответственных за обращения

-- 4. ROLE: 'board' (руководство ОСС)
--    - Требует записи в user_roles БЕЗ direction_id (NULL)
--    - Видит ВСЕ обращения (независимо от направления)
--    - Может управлять ВСЕМ контентом
--    - Может управлять ролями пользователей
--    - Имеет доступ ко всем дашбордам и аналитике
--    - Может изменять статусы любых обращений

-- 5. ROLE: 'staff' (аппарат / техподдержка)
--    - Требует записи в user_roles БЕЗ direction_id (NULL)
--    - Видит ВСЕ обращения (для технической поддержки)
--    - Может просматривать все дашборды
--    - НЕ может изменять статусы обращений (только просмотр)
--    - НЕ может управлять контентом
--    - НЕ может управлять ролями
--    - Используется для технической поддержки системы

-- ===============================
-- ПРИМЕРЫ СОЗДАНИЯ РОЛЕЙ
-- ===============================

-- Пример 1: Создать роль для руководства ОСС
-- INSERT INTO user_roles (user_id, role, direction_id)
-- VALUES ('<uuid-пользователя-из-auth>', 'board', NULL);

-- Пример 2: Создать роль руководителя направления "Правовой комитет"
-- INSERT INTO user_roles (user_id, role, direction_id)
-- SELECT 
--   '<uuid-пользователя-из-auth>',
--   'lead',
--   id
-- FROM directions
-- WHERE slug = 'legal';

-- Пример 3: Создать роль члена ОСС для направления "Стипендии"
-- INSERT INTO user_roles (user_id, role, direction_id)
-- SELECT 
--   '<uuid-пользователя-из-auth>',
--   'member',
--   id
-- FROM directions
-- WHERE slug = 'scholarship';

-- Пример 4: Создать роль аппарата
-- INSERT INTO user_roles (user_id, role, direction_id)
-- VALUES ('<uuid-пользователя-из-auth>', 'staff', NULL);

-- ===============================
-- ПРАВА ДОСТУПА ПО РОЛЯМ
-- ===============================

-- Таблица: appeals
-- - student: INSERT (создание), SELECT (только по public_token)
-- - member: SELECT (свое направление), UPDATE (свое направление)
-- - lead: SELECT (свое направление), UPDATE (свое направление)
-- - board: SELECT (все), UPDATE (все)
-- - staff: SELECT (все), UPDATE (запрещено)

-- Таблица: appeal_comments
-- - student: нет доступа
-- - member: SELECT (обращения своего направления), INSERT (обращения своего направления)
-- - lead: SELECT (обращения своего направления), INSERT (обращения своего направления)
-- - board: SELECT (все), INSERT (все)
-- - staff: SELECT (все), INSERT (запрещено)

-- Таблица: content
-- - student: SELECT (только published)
-- - member: SELECT (все)
-- - lead: SELECT (все), INSERT, UPDATE (все)
-- - board: SELECT (все), INSERT, UPDATE (все)
-- - staff: SELECT (все)

-- Таблица: documents
-- - student: SELECT (все)
-- - member: SELECT (все)
-- - lead: SELECT (все), INSERT, UPDATE (все)
-- - board: SELECT (все), INSERT, UPDATE (все)
-- - staff: SELECT (все)

-- Таблица: user_roles
-- - Все: SELECT (только свои роли)
-- - board: SELECT (все), INSERT, UPDATE, DELETE (все)
-- - staff: SELECT (все)

-- ===============================
-- ИЕРАРХИЯ РОЛЕЙ
-- ===============================

-- Уровень доступа (от меньшего к большему):
-- 1. student (внешний пользователь)
-- 2. member (член ОСС)
-- 3. lead (руководитель направления)
-- 4. staff (аппарат - просмотр всего)
-- 5. board (руководство ОСС - полный доступ)

-- ===============================
-- РЕКОМЕНДАЦИИ ПО ИСПОЛЬЗОВАНИЮ
-- ===============================

-- 1. Каждый пользователь может иметь несколько ролей
--    Например: пользователь может быть одновременно 'member' для одного направления
--    и 'lead' для другого (если это допустимо структурой ОСС)

-- 2. Для руководства ОСС используйте роль 'board' без direction_id

-- 3. Для аппарата используйте роль 'staff' без direction_id

-- 4. Для членов ОСС и руководителей направлений указывайте direction_id

-- 5. Проверка прав происходит на уровне RLS политик в Supabase

-- ===============================
-- ПРОВЕРКА РОЛЕЙ
-- ===============================

-- Проверить роли пользователя:
-- SELECT ur.*, d.title as direction_title, d.slug as direction_slug
-- FROM user_roles ur
-- LEFT JOIN directions d ON ur.direction_id = d.id
-- WHERE ur.user_id = auth.uid();

-- Проверить доступ к обращению:
-- SELECT a.*
-- FROM appeals a
-- WHERE a.id = '<appeal-id>'
--   AND (
--     -- Board и staff видят всё
--     EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role IN ('board', 'staff'))
--     OR
--     -- Lead и member видят обращения своего направления
--     EXISTS (
--       SELECT 1 FROM user_roles ur
--       WHERE ur.user_id = auth.uid()
--         AND ur.role IN ('lead', 'member')
--         AND ur.direction_id = a.direction_id
--     )
--   );

