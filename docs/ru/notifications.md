# Уведомления

Как настроить систему уведомлений для членов ОСС и техническая настройка для разработчиков.

## Для пользователей

### Как настроить уведомления

1. Войдите в админ-панель на `/admin/login`
2. Перейдите в `/admin/settings/notifications`
3. Выберите типы уведомлений:
   - **Email** — на почту
   - **Push** — в браузере (требует разрешения)
   - **Telegram** — в Telegram боте

### Типы событий

- Изменение статуса обращения
- Назначение обращения на вас
- Новые комментарии к обращениям
- Новые обращения в вашем направлении
- Просроченные обращения
- Эскалация обращений
- Ежедневная сводка (только email)

### Подключение Telegram

1. Нажмите "Подключить" для Telegram уведомлений
2. Откройте бота в Telegram (ссылка откроется автоматически)
3. Отправьте команду `/start` боту
4. Бот автоматически подключит ваш аккаунт
5. Вернитесь на страницу настроек и выберите типы событий

## Для разработчиков

### Настройка базы данных

Выполните SQL скрипт `database/notifications_schema.sql` в Supabase SQL Editor. Это создаст:
- Таблицу `notification_settings` для хранения настроек пользователей
- Таблицу `notification_log` для истории отправленных уведомлений
- Необходимые индексы и RLS политики

### Настройка Email уведомлений

#### Использование Resend

1. Зарегистрируйтесь на [Resend](https://resend.com)
2. Получите API ключ
3. Добавьте в переменные окружения Vercel:

```
EMAIL_SERVICE=resend
EMAIL_API_KEY=your_resend_api_key
EMAIL_FROM=noreply@oss-dvfu.ru
```

#### Другие сервисы

Можно адаптировать код в `app/api/notifications/email/internal/route.ts` для работы с:
- SendGrid
- Supabase Email
- AWS SES
- Другими email сервисами

### Настройка Push уведомлений

#### Генерация VAPID ключей

1. Установите библиотеку: `npm install web-push`
2. Сгенерируйте ключи:
```bash
npx web-push generate-vapid-keys
```
3. Добавьте в переменные окружения:
```
NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_public_key
VAPID_PRIVATE_KEY=your_private_key
VAPID_EMAIL=mailto:your-email@example.com
```

### Настройка Telegram бота

1. Создайте бота через [@BotFather](https://t.me/BotFather)
2. Сохраните токен
3. Добавьте в переменные окружения:
```
TELEGRAM_BOT_TOKEN=your_bot_token
NEXT_PUBLIC_TELEGRAM_BOT_USERNAME=your_bot_username
```

4. Реализуйте обработку команды `/start` в боте для сохранения `chat_id` пользователя

## Логи уведомлений

Все отправленные уведомления логируются в таблице `notification_log`:
- История отправленных уведомлений
- Статус отправки (успех/ошибка)
- Тип уведомления
- Время отправки

## Устранение проблем

### Уведомления не приходят

1. Проверьте, что уведомления включены в настройках
2. Проверьте, что выбран нужный тип события
3. Проверьте логи в `notification_log`
4. Для Telegram: убедитесь, что бот подключен (`telegram_chat_id` заполнен)

### Telegram бот не подключается

1. Убедитесь, что бот запущен
2. Проверьте, что `TELEGRAM_BOT_TOKEN` настроен
3. Убедитесь, что вы отправили команду `/start` боту
4. Проверьте, что `telegram_chat_id` сохранился в БД

### Push уведомления не работают

1. Убедитесь, что браузер поддерживает Push API
2. Проверьте, что вы разрешили уведомления в браузере
3. Убедитесь, что `NEXT_PUBLIC_VAPID_PUBLIC_KEY` настроен

