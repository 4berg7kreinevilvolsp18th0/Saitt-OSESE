# Настройка системы уведомлений

Система уведомлений позволяет администраторам и модераторам получать уведомления об изменениях в обращениях через email и push-уведомления.

## Возможности

- **Email уведомления**: Получение уведомлений на почту при изменении статуса обращений, назначении обращений и новых комментариях
- **Push уведомления**: Получение уведомлений прямо в браузере (требует разрешения)
- **Настраиваемые типы уведомлений**: Можно выбрать, какие события должны вызывать уведомления
- **Ежедневная сводка**: Опциональная ежедневная сводка по обращениям

## Настройка базы данных

Сначала нужно выполнить SQL скрипт для создания таблиц настроек уведомлений:

```sql
-- Выполните файл database/notifications_schema.sql в Supabase SQL Editor
```

Это создаст:
- Таблицу `notification_settings` для хранения настроек пользователей
- Таблицу `notification_log` для истории отправленных уведомлений
- Необходимые индексы и RLS политики

## Настройка Email уведомлений

```

### Использование других сервисов

Можно адаптировать код в `app/api/notifications/email/internal/route.ts` для работы с:
- SendGrid
- Supabase Email
- AWS SES
- Другими email сервисами

## Настройка Push уведомлений

### Генерация VAPID ключей

1. Установите библиотеку `web-push`:
```bash
npm install web-push
```

2. Сгенерируйте ключи:
```bash
npx web-push generate-vapid-keys
```

3. Добавьте в переменные окружения:
```
NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_public_key
VAPID_PRIVATE_KEY=your_private_key
VAPID_EMAIL=mailto:your@email.com
```

### Настройка Service Worker

Service Worker уже создан в `public/sw.js`. Убедитесь, что он доступен по пути `/sw.js`.

## Использование

### Регистрация администраторов

1. Перейдите на `/admin/register`
2. Заполните форму регистрации:
   - ФИО
   - Email
   - Пароль (минимум 8 символов)
   - Роль (член ОСС, руководитель направления, руководство ОСС, аппарат)
3. После регистрации требуется подтверждение от администратора

### Настройка уведомлений

1. Войдите в админ-панель
2. Перейдите в "Уведомления" в главном меню
3. Настройте предпочтения:
   - Включите/выключите email уведомления
   - Выберите типы событий для email
   - Включите push уведомления (требует разрешения браузера)
   - Выберите типы событий для push

### Типы уведомлений

- **Изменение статуса обращения**: Когда статус обращения изменяется
- **Назначение обращения**: Когда обращение назначается на вас
- **Новые комментарии**: Когда к обращению добавляется комментарий
- **Ежедневная сводка**: Ежедневный обзор обращений (только email)

## Автоматическая отправка уведомлений

Уведомления отправляются автоматически при:
- Изменении статуса обращения (уведомление назначенному пользователю)
- Назначении обращения на пользователя
- Добавлении комментария к обращению (в разработке)

## Логирование

Все отправленные уведомления логируются в таблицу `notification_log` для отслеживания и отладки.

## Troubleshooting

### Push уведомления не работают

1. Убедитесь, что браузер поддерживает Service Workers и Push API
2. Проверьте, что VAPID ключи настроены правильно
3. Убедитесь, что пользователь дал разрешение на уведомления
4. Проверьте консоль браузера на наличие ошибок

### Email уведомления не отправляются

1. Проверьте настройки email сервиса в переменных окружения
2. Убедитесь, что API ключ действителен
3. Проверьте логи в таблице `notification_log`
4. Убедитесь, что у пользователя включены email уведомления в настройках

