# Исправление ошибки "Forbidden use of secret API key in browser"

## Проблема

На странице появляется ошибка:
```
Forbidden use of secret API key in browser
```

## Причина

В переменных окружения Vercel установлен **SERVICE_ROLE** ключ вместо **ANON** ключа.

**КРИТИЧНО:** SERVICE_ROLE ключ имеет полный доступ к базе данных и **НИКОГДА** не должен использоваться в браузере!

## Решение

### Шаг 1: Проверьте переменные окружения в Vercel

1. Зайдите в **Vercel Dashboard** → ваш проект
2. Перейдите в **Settings** → **Environment Variables**
3. Проверьте переменную `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### Шаг 2: Убедитесь, что используется правильный ключ

#### ✅ ПРАВИЛЬНО: ANON PUBLIC ключ

В Supabase Dashboard:
1. **Settings** → **API**
2. Найдите секцию **Project API keys**
3. Скопируйте ключ из **"anon public"** (НЕ "service_role"!)

Характеристики anon ключа:
- Обычно начинается с `eyJ...`
- Длина примерно 150-200 символов
- Название: **"anon public"** или **"anon"**

#### ❌ НЕПРАВИЛЬНО: SERVICE_ROLE ключ

**НИКОГДА не используйте:**
- `service_role` ключ
- Ключ из секции "service_role" в Supabase Dashboard
- Любой ключ длиннее 200 символов

### Шаг 3: Обновите переменную окружения

1. В Vercel Dashboard → **Settings** → **Environment Variables**
2. Найдите `NEXT_PUBLIC_SUPABASE_ANON_KEY`
3. Нажмите **"Edit"**
4. Вставьте правильный **anon public** ключ из Supabase
5. Убедитесь, что выбран тип **"Plain"** (не "Secret" - это для других целей)
6. Выберите все окружения: **Production, Preview, Development**
7. Нажмите **"Save"**

### Шаг 4: Удалите неправильные переменные (если есть)

Если в Vercel есть переменные:
- `NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY` ❌
- `SUPABASE_SERVICE_ROLE_KEY` ❌
- Любые другие с "service_role" ❌

**УДАЛИТЕ ИХ НЕМЕДЛЕННО!**

### Шаг 5: Перезапустите деплой

1. **Deployments** → последний деплой
2. Нажмите **"..."** → **"Redeploy"**
3. Дождитесь завершения сборки

## Проверка

После исправления:

1. Откройте сайт
2. Откройте консоль браузера (F12)
3. Ошибка "Forbidden use of secret API key" должна исчезнуть
4. Сайт должен работать нормально

## Где найти правильный ключ

### В Supabase Dashboard:

1. Зайдите в ваш проект Supabase
2. Перейдите в **Settings** → **API**
3. Найдите секцию **"Project API keys"**
4. Скопируйте ключ из **"anon public"** (первый ключ в списке)

**ВАЖНО:** 
- Используйте ключ из колонки **"anon public"**
- НЕ используйте ключ из колонки **"service_role"**

## Безопасность

### Почему это важно?

- **ANON ключ:** Безопасен для браузера, ограничен RLS политиками
- **SERVICE_ROLE ключ:** Обходит все RLS политики, полный доступ к БД

Если SERVICE_ROLE ключ попадет в браузер:
- ❌ Любой может получить полный доступ к базе данных
- ❌ Можно удалить все данные
- ❌ Можно изменить любые записи
- ❌ Критическая уязвимость безопасности!

## Дополнительная защита

Код теперь автоматически проверяет, что используется правильный ключ:
- Если обнаружен service_role ключ - показывается ошибка
- Предупреждение в консоли, если ключ выглядит подозрительно

## Если проблема сохраняется

1. Проверьте, что ключ скопирован полностью (без пробелов)
2. Убедитесь, что используется именно "anon public" ключ
3. Очистите кеш браузера (Ctrl+Shift+Delete)
4. Проверьте логи Vercel на наличие ошибок

