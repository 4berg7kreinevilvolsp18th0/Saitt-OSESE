# Настройка Email уведомлений

## Обзор

Система автоматически отправляет email уведомления студентам при изменении статуса их обращения.

## Поддерживаемые сервисы

- **Resend** (рекомендуется) - простой и надёжный
- **SendGrid** - популярный сервис
- **Supabase Email** - встроенный в Supabase

## Настройка Resend

### Шаг 1: Регистрация

1. Зайдите на [resend.com](https://resend.com)
2. Зарегистрируйтесь (бесплатный план: 3000 писем/месяц)
3. Подтвердите email

### Шаг 2: Создание API ключа

1. В Dashboard → **API Keys**
2. Нажмите **"Create API Key"**
3. Дайте название (например, "OSS DVFU Production")
4. Скопируйте ключ (начинается с `re_`)

### Шаг 3: Подтверждение домена (для production)

1. Dashboard → **Domains**
2. Добавьте ваш домен (например, `oss-dvfu.ru`)
3. Добавьте DNS записи в настройках домена:
   - SPF запись
   - DKIM записи
   - DMARC (опционально)
4. Дождитесь подтверждения (обычно несколько минут)

### Шаг 4: Настройка в Vercel

Добавьте переменные окружения в Vercel:

```
EMAIL_SERVICE=resend
EMAIL_API_KEY=re_xxxxxxxxxxxxx
EMAIL_FROM=noreply@oss-dvfu.ru
```

**Важно:**
- `EMAIL_FROM` должен быть подтверждённым доменом в Resend
- Для тестирования можно использовать `onboarding@resend.dev`

### Шаг 5: Проверка

1. Измените статус обращения в админ-панели
2. Проверьте email студента
3. Проверьте логи Vercel для ошибок

## Настройка SendGrid

1. Зарегистрируйтесь на [sendgrid.com](https://sendgrid.com)
2. Создайте API ключ
3. Добавьте в Vercel:
   ```
   EMAIL_SERVICE=sendgrid
   EMAIL_API_KEY=SG.xxxxxxxxxxxxx
   EMAIL_FROM=noreply@oss-dvfu.ru
   ```

**Примечание:** Код для SendGrid нужно добавить в `app/api/notifications/email/route.ts`

## Настройка Supabase Email

Supabase имеет встроенную поддержку email, но требует настройки SMTP:

1. Supabase Dashboard → **Settings** → **Auth** → **SMTP Settings**
2. Настройте SMTP сервер
3. Используйте Supabase API для отправки

## Шаблоны писем

Текущие шаблоны находятся в `app/api/notifications/email/route.ts`.

Можно улучшить:
- Добавить логотип ОСС
- Персонализировать стиль
- Добавить ссылки на социальные сети
- Многоязычные шаблоны

## Тестирование

### Локально

1. Добавьте переменные в `.env.local`:
   ```
   EMAIL_SERVICE=resend
   EMAIL_API_KEY=your-test-key
   EMAIL_FROM=onboarding@resend.dev
   ```

2. Запустите dev сервер
3. Измените статус обращения
4. Проверьте email

### В Production

1. Убедитесь, что домен подтверждён
2. Проверьте, что `EMAIL_FROM` использует ваш домен
3. Протестируйте отправку
4. Мониторьте логи Vercel

## Troubleshooting

**Письма не отправляются:**
- Проверьте API ключ
- Проверьте, что домен подтверждён (для production)
- Проверьте логи Vercel
- Убедитесь, что `EMAIL_FROM` правильный

**Письма попадают в спам:**
- Настройте SPF, DKIM, DMARC записи
- Используйте подтверждённый домен
- Избегайте спам-триггеров в тексте

**Ошибка "Invalid API key":**
- Проверьте, что ключ скопирован полностью
- Убедитесь, что нет лишних пробелов
- Проверьте, что ключ активен в Resend

## Лимиты

**Resend Free:**
- 3000 писем/месяц
- 100 писем/день

**Resend Pro:**
- 50,000 писем/месяц
- $20/месяц

Для больших объёмов рассмотрите SendGrid или другие сервисы.

