# Диагностика ошибки 404 на Vercel

## Быстрая проверка

### 1. Проверьте переменные окружения в Vercel

1. Зайдите в Vercel Dashboard → ваш проект
2. Перейдите в **Settings** → **Environment Variables**
3. Убедитесь, что установлены:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `NEXT_PUBLIC_SITE_URL`

4. Проверьте, что переменные применены ко всем окружениям (Production, Preview, Development)

### 2. Проверьте endpoint диагностики

После деплоя откройте:
```
https://ваш-домен.vercel.app/api/health
```

Должен вернуться JSON с информацией о настройке Supabase.

### 3. Проверьте логи Vercel

1. Vercel Dashboard → ваш проект → **Deployments**
2. Откройте последний деплой
3. Перейдите на вкладку **Logs**
4. Ищите ошибки, связанные с:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `404`
   - `NOT_FOUND`

### 4. Проверьте консоль браузера

1. Откройте сайт
2. Нажмите F12 (открыть DevTools)
3. Перейдите на вкладку **Console**
4. Ищите ошибки:
   - `❌ Supabase не настроен!`
   - `404`
   - `NOT_FOUND`

### 5. Проверьте Network tab

1. В DevTools перейдите на вкладку **Network**
2. Обновите страницу
3. Ищите запросы к Supabase (должны быть к `*.supabase.co`)
4. Проверьте статус ответов:
   - **200** - OK
   - **404** - Ресурс не найден
   - **401** - Не авторизован
   - **403** - Доступ запрещен

## Типичные причины 404

### Причина 1: Переменные окружения не установлены

**Симптомы:**
- В консоли: `❌ Supabase не настроен!`
- В `/api/health`: `supabase.configured: false`

**Решение:**
1. Добавьте переменные окружения в Vercel
2. Перезапустите деплой (Redeploy)

### Причина 2: Неправильный URL Supabase

**Симптомы:**
- В консоли: `⚠️ NEXT_PUBLIC_SUPABASE_URL выглядит неправильно`
- Запросы идут не к `*.supabase.co`

**Решение:**
1. Проверьте URL в Supabase Dashboard → Settings → API
2. URL должен быть вида: `https://xxxxx.supabase.co`
3. Обновите переменную в Vercel
4. Перезапустите деплой

### Причина 3: Таблицы не созданы в Supabase

**Симптомы:**
- В Network tab: 404 на запросы к таблицам
- В консоли: `Таблица не найдена`

**Решение:**
1. Выполните `database/schema.sql` в Supabase SQL Editor
2. Проверьте создание таблиц: `database/VERIFY_SETUP.sql`

### Причина 4: RLS политики блокируют доступ

**Симптомы:**
- В Network tab: 403 на запросы
- Данные не загружаются

**Решение:**
1. Проверьте RLS политики в Supabase Dashboard → Authentication → Policies
2. Убедитесь, что политики для публичного чтения созданы
3. Проверьте `database/schema.sql` - все политики должны быть выполнены

### Причина 5: Неправильный формат ключа

**Симптомы:**
- В консоли: ошибки авторизации
- 401 на запросы

**Решение:**
1. Используйте **anon public** ключ, а не **service_role**
2. Ключ должен быть длинной строкой (обычно начинается с `eyJ...`)
3. Скопируйте ключ заново из Supabase Dashboard

## Пошаговая диагностика

### Шаг 1: Проверка переменных окружения

```bash
# Локально (в .env.local)
NEXT_PUBLIC_SUPABASE_URL=https://ваш-проект.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ваш-ключ
```

### Шаг 2: Проверка подключения

Откройте в браузере:
```
http://localhost:3000/api/health
```

Должен вернуться JSON с `supabase.configured: true`

### Шаг 3: Проверка Supabase

В Supabase Dashboard:
1. SQL Editor → выполните `SELECT * FROM directions LIMIT 1;`
2. Должна вернуться хотя бы одна строка (если seed.sql выполнен)

### Шаг 4: Проверка RLS

В Supabase Dashboard:
1. Table Editor → выберите таблицу `directions`
2. Попробуйте прочитать данные
3. Если ошибка - проверьте RLS политики

## Получение помощи

Если проблема не решена:

1. Соберите информацию:
   - Скриншот `/api/health` endpoint
   - Скриншот консоли браузера (F12)
   - Скриншот Network tab с запросами к Supabase
   - Логи из Vercel Dashboard

2. Проверьте документацию:
   - `docs/SUPABASE_SETUP.md` - настройка Supabase
   - `QUICK_FIX_404.md` - быстрое исправление
   - `docs/DEPLOY.md` - инструкция по деплою

3. Проверьте, что все шаги выполнены:
   - ✅ Проект создан в Supabase
   - ✅ `schema.sql` выполнен
   - ✅ Переменные окружения установлены в Vercel
   - ✅ Деплой перезапущен после установки переменных

