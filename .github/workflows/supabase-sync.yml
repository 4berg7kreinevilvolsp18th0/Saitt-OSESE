name: Supabase Database Sync

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'database/**'
      - '.github/workflows/supabase-sync.yml'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ 3:00 UTC –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    - cron: '0 3 * * *'

jobs:
  sync-database:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Supabase CLI
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Supabase CLI —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
          curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
          supabase --version
          echo "‚úÖ Supabase CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
      
      - name: Login to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå SUPABASE_ACCESS_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token -
          echo "‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ Supabase"
      
      - name: Link to Supabase project
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "‚ùå SUPABASE_PROJECT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "üîó –°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–µ–∫—Ç–æ–º: $SUPABASE_PROJECT_ID"
          supabase link --project-ref $SUPABASE_PROJECT_ID
          echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–≤—è–∑–∞–Ω"
      
      - name: Initialize Supabase project (if needed)
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ config.toml
          if [ ! -f "supabase/config.toml" ]; then
            echo "üìù –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –ø—Ä–æ–µ–∫—Ç–∞..."
            supabase init
          else
            echo "‚úÖ Supabase –ø—Ä–æ–µ–∫—Ç —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
          fi
      
      - name: Check migration files
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π..."
          if [ ! -d "database/migrations" ]; then
            echo "‚ùå –ü–∞–ø–∫–∞ database/migrations –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            exit 1
          fi
          MIGRATION_COUNT=$(find database/migrations -name "*.sql" | wc -l)
          echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–∏–≥—Ä–∞—Ü–∏–π: $MIGRATION_COUNT"
          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è  –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"
            exit 0
          fi
          ls -la database/migrations/*.sql
      
      - name: Copy migrations to Supabase directory
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è Supabase CLI
          mkdir -p supabase/migrations
          # –ö–æ–ø–∏—Ä—É–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
          cp database/migrations/*.sql supabase/migrations/ 2>/dev/null || true
          echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ supabase/migrations/"
          ls -la supabase/migrations/ | head -10
      
      - name: Check migration status
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π..."
          supabase migration list || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)"
      
      - name: Apply migrations
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
          if [ ! -d "supabase/migrations" ] || [ -z "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  –ù–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"
            exit 0
          fi
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ db push (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤)
          echo "üì§ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ db push..."
          supabase db push --linked || {
            echo "‚ö†Ô∏è  db push –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ migration up..."
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥: –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
            supabase migration up --linked || {
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
              echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
              exit 1
            }
          }
          echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
      
      - name: Verify migrations applied
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π..."
          supabase migration list
          echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
      
      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ Supabase"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
          echo "1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å SUPABASE_ACCESS_TOKEN"
          echo "2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å SUPABASE_PROJECT_ID"
          echo "3. –ß—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ database/migrations/"
          echo "4. –°–∏–Ω—Ç–∞–∫—Å–∏—Å SQL –≤ —Ñ–∞–π–ª–∞—Ö –º–∏–≥—Ä–∞—Ü–∏–π"
          echo ""
          echo "–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ workflow –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub Actions UI"
          exit 1

