name: Supabase Database Sync

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'database/**'
      - '.github/workflows/supabase-sync.yml'
  workflow_dispatch: # Позволяет запускать вручную из GitHub UI
  schedule:
    # Запускать каждую ночь в 3:00 UTC для проверки синхронизации
    - cron: '0 3 * * *'

jobs:
  sync-database:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Полная история для миграций
      
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Verify CLI installation
        run: |
          supabase --version
          echo "✅ Supabase CLI установлен"
      
      - name: Login to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "❌ Ошибка: SUPABASE_ACCESS_TOKEN не установлен"
            exit 1
          fi
          echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token -
          echo "✅ Успешный вход в Supabase"
      
      - name: Initialize Supabase project structure
        run: |
          # Создаем структуру Supabase проекта, если её нет
          if [ ! -d "supabase" ]; then
            echo "Создание структуры Supabase проекта..."
            mkdir -p supabase/migrations
            # Создаем минимальный config.toml
            cat > supabase/config.toml << 'EOF'
          [project]
          id = ""
          
          [api]
          enabled = true
          port = 54321
          schemas = ["public", "storage", "graphql_public"]
          extra_search_path = ["public", "extensions"]
          
          [db]
          port = 54322
          major_version = 15
          EOF
            echo "✅ Структура Supabase создана"
          else
            echo "✅ Структура Supabase уже существует"
          fi
      
      - name: Copy migrations to Supabase structure
        run: |
          # Копируем миграции из database/migrations в supabase/migrations
          if [ -d "database/migrations" ]; then
            echo "Копирование миграций..."
            cp -r database/migrations/* supabase/migrations/ 2>/dev/null || true
            echo "✅ Миграции скопированы"
            echo "Список миграций:"
            ls -la supabase/migrations/ || echo "Папка миграций пуста"
          else
            echo "⚠️ Папка database/migrations не найдена"
          fi
      
      - name: Link to Supabase project
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "❌ Ошибка: SUPABASE_PROJECT_ID не установлен"
            exit 1
          fi
          echo "Связывание с проектом: $SUPABASE_PROJECT_ID"
          supabase link --project-ref "$SUPABASE_PROJECT_ID" || {
            echo "⚠️ Предупреждение: Не удалось связать проект (возможно, уже связан)"
          }
          echo "✅ Проект связан"
      
      - name: List existing migrations
        run: |
          echo "Проверка существующих миграций в Supabase..."
          supabase migration list || echo "⚠️ Не удалось получить список миграций"
      
      - name: Apply migrations
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Применение миграций..."
          if [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "⚠️ SUPABASE_DB_PASSWORD не установлен, используем db push без пароля"
          fi
          
          # Применяем миграции
          supabase db push --db-url "postgresql://postgres:[$SUPABASE_DB_PASSWORD]@db.[${{ secrets.SUPABASE_PROJECT_ID }}].supabase.co:5432/postgres" || \
          supabase db push || {
            echo "❌ Ошибка при применении миграций"
            echo "Попытка применения через прямой SQL..."
            exit 1
          }
          echo "✅ Миграции применены"
      
      - name: Verify migrations
        run: |
          echo "Проверка статуса миграций..."
          supabase migration list || echo "⚠️ Не удалось проверить статус"
          echo "✅ Проверка завершена"
      
      - name: Notify on success
        if: success()
        run: |
          echo "✅✅✅ Миграции успешно применены к Supabase ✅✅✅"
          echo "Проверьте Supabase Dashboard для подтверждения"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌❌❌ Ошибка при применении миграций ❌❌❌"
          echo "Проверьте логи выше для деталей"
          echo "Убедитесь, что все секреты установлены правильно:"
          echo "  - SUPABASE_ACCESS_TOKEN"
          echo "  - SUPABASE_PROJECT_ID"
          echo "  - SUPABASE_DB_PASSWORD"

