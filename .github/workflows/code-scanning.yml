name: Code Scanning

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  schedule:
    # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 8:00 UTC (17:00 Ð¿Ð¾ Ð’Ð»Ð°Ð´Ð¸Ð²Ð¾ÑÑ‚Ð¾ÐºÑƒ)
    - cron: "0 8 * * 1"
  workflow_dispatch:

jobs:
  code-scanning:
    name: Comprehensive Code Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/nextjs/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend/nextjs
        run: npm ci

      - name: Run ESLint with security rules
        working-directory: ./frontend/nextjs
        run: |
          echo "ðŸ” Ð—Ð°Ð¿ÑƒÑÐº ESLint Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
          npm run lint -- --max-warnings 0 || true
        continue-on-error: true

      - name: Check for security anti-patterns
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð°Ð½Ñ‚Ð¸-Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ innerHTML
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° innerHTML..."
          if grep -r "innerHTML" frontend/nextjs/app frontend/nextjs/components frontend/nextjs/lib \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | \
            grep -v "dangerouslySetInnerHTML" | grep -v "//" | head -5; then
            echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ innerHTML. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ textContent Ð¸Ð»Ð¸ ÑÐ°Ð½Ð¸Ñ‚Ð¸Ð·Ð°Ñ†Ð¸ÑŽ."
          else
            echo "âœ… innerHTML Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° eval
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° eval..."
          if grep -r "eval(" frontend/nextjs/app frontend/nextjs/components frontend/nextjs/lib \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null; then
            echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ eval() - ÑÑ‚Ð¾ Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾!"
            exit 1
          else
            echo "âœ… eval() Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° document.write
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° document.write..."
          if grep -r "document\.write" frontend/nextjs/app frontend/nextjs/components frontend/nextjs/lib \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null; then
            echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ document.write - ÑÑ‚Ð¾ Ð½Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ"
          else
            echo "âœ… document.write Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ window.location Ð±ÐµÐ· Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° window.location..."
          if grep -r "window\.location\s*=" frontend/nextjs/app frontend/nextjs/components frontend/nextjs/lib \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | \
            grep -v "//" | head -5; then
            echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ñ€ÑÐ¼Ð¾Ðµ Ð¿Ñ€Ð¸ÑÐ²Ð°Ð¸Ð²Ð°Ð½Ð¸Ðµ window.location. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ð² Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸."
          else
            echo "âœ… window.location Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾"
          fi
        continue-on-error: true

      - name: Check SQL injection risks
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ€Ð¸ÑÐºÐ¸ SQL injection..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ template strings Ð² SQL (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð‘Ð”)
          if [ -d "backend/python" ]; then
            echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python ÐºÐ¾Ð´Ð° Ð½Ð° SQL injection..."
            if grep -r "f\".*SELECT\|f\".*INSERT\|f\".*UPDATE\|f\".*DELETE" backend/python \
              --include="*.py" 2>/dev/null | grep -v "#" | head -5; then
              echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ f-strings Ð² SQL. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹."
            else
              echo "âœ… SQL Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ‹Ð³Ð»ÑÐ´ÑÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾"
            fi
          fi
        continue-on-error: true

      - name: Check for exposed credentials
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° .env Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
          if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" 2>/dev/null | head -5; then
            echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ .env Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸! ÐžÐ½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð² .gitignore"
            exit 1
          else
            echo "âœ… .env Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÐºÐ»ÑŽÑ‡Ð¸ Ð² ÐºÐ¾Ð´Ðµ
          if grep -rE "(sk_live|pk_live|sk_test|pk_test|AIza|AKIA|aws_access_key)" \
            frontend/ backend/ database/ .github/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.py" \
            2>/dev/null | grep -v ".git" | grep -v "node_modules" | head -5; then
            echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸ API Ð² ÐºÐ¾Ð´Ðµ!"
            exit 1
          else
            echo "âœ… API ÐºÐ»ÑŽÑ‡Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² ÐºÐ¾Ð´Ðµ"
          fi
        continue-on-error: true

      - name: Save scan results
        if: always()
        run: |
          {
            echo "{"
            echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\","
            echo "  \"workflow\": \"Code Scanning\","
            echo "  \"checks\": {"
            echo "    \"eslint\": \"completed\","
            echo "    \"security_patterns\": \"completed\","
            echo "    \"sql_injection\": \"completed\","
            echo "    \"exposed_credentials\": \"completed\""
            echo "  }"
            echo "}"
        } > scan-results.json

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-scanning-results
          path: scan-results.json
          retention-days: 30

      - name: Generate scan summary
        if: always()
        run: |
          echo "## ðŸ” Code Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹:" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ð½Ñ‚Ð¸-Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð¾Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° SQL injection" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ 'code-scanning-results' Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹." >> $GITHUB_STEP_SUMMARY

