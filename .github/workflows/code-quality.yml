name: Code Quality Check

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  lint:
    name: ESLint & TypeScript Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/nextjs/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend/nextjs
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend/nextjs
        run: npm run lint || true
        continue-on-error: true

      - name: TypeScript type check
        working-directory: ./frontend/nextjs
        run: |
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit --pretty || true
          else
            echo "âš ï¸  tsconfig.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ‚Ð¸Ð¿Ð¾Ð²"
          fi
        continue-on-error: true

      - name: Check for console.log
        working-directory: ./frontend/nextjs
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° console.log Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÐºÐ¾Ð´Ðµ..."
          if grep -r "console\.log" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ components/ lib/ 2>/dev/null | grep -v "// eslint-disable" | grep -v "console.log(" | head -20; then
            echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ console.log. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ console.error Ð¸Ð»Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÐºÐ¾Ð´Ðµ."
          else
            echo "âœ… console.log Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð¸Ð»Ð¸ Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
          fi
        continue-on-error: true

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend/nextjs
        run: npm ci

      - name: Check for security issues in code
        working-directory: ./frontend/nextjs
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
          # ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº ESLint
          if [ -f "eslint-results.json" ]; then
            ESLINT_ERRORS=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' eslint-results.json 2>/dev/null || echo "0")
            ESLINT_WARNINGS=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' eslint-results.json 2>/dev/null || echo "0")
            echo "### ESLint:" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ÐžÑˆÐ¸Ð±Ð¾Ðº: $ESLINT_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸  ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹: $ESLINT_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº TypeScript
          if [ -f "tsc-results.txt" ]; then
            TS_ERRORS=$(grep -c "error TS" tsc-results.txt 2>/dev/null || echo "0")
            echo "### TypeScript:" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ÐžÑˆÐ¸Ð±Ð¾Ðº Ñ‚Ð¸Ð¿Ð¾Ð²: $TS_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹:" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° console.log" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð´Ð°" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ 'code-quality-results' Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹." >> $GITHUB_STEP_SUMMARY

