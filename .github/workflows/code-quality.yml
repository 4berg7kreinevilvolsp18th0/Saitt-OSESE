name: Code Quality Check

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  lint:
    name: ESLint & TypeScript Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/nextjs/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend/nextjs
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend/nextjs
        run: npm run lint || true
        continue-on-error: true

      - name: TypeScript type check
        working-directory: ./frontend/nextjs
        run: |
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit --pretty || true
          else
            echo "âš ï¸  tsconfig.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ‚Ð¸Ð¿Ð¾Ð²"
          fi
        continue-on-error: true

      - name: Check for console.log
        working-directory: ./frontend/nextjs
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° console.log Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÐºÐ¾Ð´Ðµ..."
          if grep -r "console\.log" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ components/ lib/ 2>/dev/null | grep -v "// eslint-disable" | grep -v "console.log(" | head -20; then
            echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ console.log. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ console.error Ð¸Ð»Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÐºÐ¾Ð´Ðµ."
          else
            echo "âœ… console.log Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð¸Ð»Ð¸ Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
          fi
        continue-on-error: true

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend/nextjs
        run: npm ci

      - name: Check for security issues in code
        working-directory: ./frontend/nextjs
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° hardcoded ÑÐµÐºÑ€ÐµÑ‚Ñ‹
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° hardcoded ÑÐµÐºÑ€ÐµÑ‚Ñ‹..."
          if grep -rE "(password|secret|key|token|api_key|apikey)\s*=\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ components/ lib/ 2>/dev/null | grep -v "process.env" | grep -v "//" | head -10; then
            echo "âš ï¸  Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ hardcoded ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð´ Ð²Ñ‹ÑˆÐµ."
          else
            echo "âœ… Hardcoded ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ eval
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ eval..."
          if grep -r "eval(" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ components/ lib/ 2>/dev/null; then
            echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ eval() - ÑÑ‚Ð¾ Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾!"
            exit 1
          else
            echo "âœ… eval() Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° innerHTML Ð±ÐµÐ· ÑÐ°Ð½Ð¸Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
          echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° innerHTML..."
          if grep -r "innerHTML" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ components/ lib/ 2>/dev/null | grep -v "dangerouslySetInnerHTML" | head -5; then
            echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ innerHTML. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ°Ð½Ð¸Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹."
          else
            echo "âœ… innerHTML Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾"
          fi
        continue-on-error: true

      - name: Check file sizes
        run: |
          echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          find frontend/nextjs -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) -size +500k -exec ls -lh {} \; | head -10 || echo "âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€"
        continue-on-error: true

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, code-analysis]
    if: always()

    steps:
      - name: Run ESLint and save results
        working-directory: ./frontend/nextjs
        run: |
          npm run lint -- --format json --output-file ../eslint-results.json || true
        continue-on-error: true

      - name: Run TypeScript check and save results
        working-directory: ./frontend/nextjs
        run: |
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit --pretty false 2>&1 | tee ../tsc-results.txt || true
          fi
        continue-on-error: true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-results
          path: |
            eslint-results.json
            tsc-results.txt
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº ESLint
          if [ -f "eslint-results.json" ]; then
            ESLINT_ERRORS=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' eslint-results.json 2>/dev/null || echo "0")
            ESLINT_WARNINGS=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' eslint-results.json 2>/dev/null || echo "0")
            echo "### ESLint:" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ÐžÑˆÐ¸Ð±Ð¾Ðº: $ESLINT_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸  ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹: $ESLINT_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº TypeScript
          if [ -f "tsc-results.txt" ]; then
            TS_ERRORS=$(grep -c "error TS" tsc-results.txt 2>/dev/null || echo "0")
            echo "### TypeScript:" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ÐžÑˆÐ¸Ð±Ð¾Ðº Ñ‚Ð¸Ð¿Ð¾Ð²: $TS_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹:" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° console.log" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð´Ð°" >> $GITHUB_STEP_SUMMARY
          echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ 'code-quality-results' Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹." >> $GITHUB_STEP_SUMMARY

