name: Secret Scanning

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  secret-scanning:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          no-git: false
          verbose: true
          redact: true

      - name: Check for hardcoded secrets
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hardcoded —Å–µ–∫—Ä–µ—Ç—ã..."
          
          # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "private[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "access[_-]?token\s*=\s*['\"][^'\"]+['\"]"
          )
          
          FOUND_SECRETS=false
          
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.py" --include="*.json" \
              frontend/ backend/ database/ .github/ 2>/dev/null | \
              grep -v "process.env" | \
              grep -v "NEXT_PUBLIC" | \
              grep -v "//" | \
              grep -v "example" | \
              grep -v "placeholder" | \
              grep -v "test" | \
              grep -v "TODO"; then
              echo "‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞–π–¥–µ–Ω—ã —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ hardcoded —Å–µ–∫—Ä–µ—Ç—ã!"
            echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ GitHub Secrets."
            exit 1
          else
            echo "‚úÖ Hardcoded —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          fi

